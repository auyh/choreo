#!/usr/bin/env bash

# 生成配置文件
cat > /tmp/config <<EOF
ewogICAgImxvZyI6ewogICAgICAgICJhY2Nlc3MiOiIvZGV2L251bGwiLAogICAgICAgICJlcnJv
ciI6Ii9kZXYvbnVsbCIsCiAgICAgICAgImxvZ2xldmVsIjoibm9uZSIKICAgIH0sCiAgICAiaW5i
b3VuZHMiOlsKICAgICAgICB7CiAgICAgICAgICAgICJwb3J0Ijo0NDMsCiAgICAgICAgICAgICJw
cm90b2NvbCI6InZsZXNzIiwKICAgICAgICAgICAgInNldHRpbmdzIjp7CiAgICAgICAgICAgICAg
ICAiY2xpZW50cyI6WwogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAg
ICAgImlkIjoiVVVJRCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJmbG93IjoieHRscy1ycHJ4
LXZpc2lvbiIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBdLAogICAgICAg
ICAgICAgICAgImRlY3J5cHRpb24iOiJub25lIiwKICAgICAgICAgICAgICAgICJmYWxsYmFja3Mi
OlsKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICJkZXN0Ijoz
MDAxCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAg
ICAgICAgICAgICAgICAgICJwYXRoIjoiL1dTUEFUSC12bGVzcyIsCiAgICAgICAgICAgICAgICAg
ICAgICAgICJkZXN0IjozMDAyCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAg
ICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICJwYXRoIjoiL1dTUEFUSC12bWVzcyIsCiAg
ICAgICAgICAgICAgICAgICAgICAgICJkZXN0IjozMDAzCiAgICAgICAgICAgICAgICAgICAgfSwK
ICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICJwYXRoIjoiL1dT
UEFUSC10cm9qYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzdCI6MzAwNAogICAgICAg
ICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAg
ICAgICAicGF0aCI6Ii9XU1BBVEgtc2hhZG93c29ja3MiLAogICAgICAgICAgICAgICAgICAgICAg
ICAiZGVzdCI6MzAwNQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIF0KICAg
ICAgICAgICAgfSwKICAgICAgICAgICAgInN0cmVhbVNldHRpbmdzIjp7CiAgICAgICAgICAgICAg
ICAibmV0d29yayI6InRjcCIKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgewogICAg
ICAgICAgICAicG9ydCI6MzAwMSwKICAgICAgICAgICAgImxpc3RlbiI6IjEyNy4wLjAuMSIsCiAg
ICAgICAgICAgICJwcm90b2NvbCI6InZsZXNzIiwKICAgICAgICAgICAgInNldHRpbmdzIjp7CiAg
ICAgICAgICAgICAgICAiY2xpZW50cyI6WwogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAg
ICAgICAgICAgICAgICAgImlkIjoiVVVJRCIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAg
ICAgICAgICBdLAogICAgICAgICAgICAgICAgImRlY3J5cHRpb24iOiJub25lIgogICAgICAgICAg
ICB9LAogICAgICAgICAgICAic3RyZWFtU2V0dGluZ3MiOnsKICAgICAgICAgICAgICAgICJuZXR3
b3JrIjoid3MiLAogICAgICAgICAgICAgICAgInNlY3VyaXR5Ijoibm9uZSIKICAgICAgICAgICAg
fQogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICAicG9ydCI6MzAwMiwKICAgICAgICAg
ICAgImxpc3RlbiI6IjEyNy4wLjAuMSIsCiAgICAgICAgICAgICJwcm90b2NvbCI6InZsZXNzIiwK
ICAgICAgICAgICAgInNldHRpbmdzIjp7CiAgICAgICAgICAgICAgICAiY2xpZW50cyI6WwogICAg
ICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgImlkIjoiVVVJRCIsCiAg
ICAgICAgICAgICAgICAgICAgICAgICJsZXZlbCI6MAogICAgICAgICAgICAgICAgICAgIH0KICAg
ICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAiZGVjcnlwdGlvbiI6Im5vbmUiCiAgICAg
ICAgICAgIH0sCiAgICAgICAgICAgICJzdHJlYW1TZXR0aW5ncyI6ewogICAgICAgICAgICAgICAg
Im5ldHdvcmsiOiJ3cyIsCiAgICAgICAgICAgICAgICAic2VjdXJpdHkiOiJub25lIiwKICAgICAg
ICAgICAgICAgICJ3c1NldHRpbmdzIjp7CiAgICAgICAgICAgICAgICAgICAgInBhdGgiOiIvV1NQ
QVRILXZsZXNzIgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAi
c25pZmZpbmciOnsKICAgICAgICAgICAgICAgICJlbmFibGVkIjp0cnVlLAogICAgICAgICAgICAg
ICAgImRlc3RPdmVycmlkZSI6WwogICAgICAgICAgICAgICAgICAgICJodHRwIiwKICAgICAgICAg
ICAgICAgICAgICAidGxzIgogICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICJtZXRh
ZGF0YU9ubHkiOmZhbHNlCiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHsKICAgICAg
ICAgICAgInBvcnQiOjMwMDMsCiAgICAgICAgICAgICJsaXN0ZW4iOiIxMjcuMC4wLjEiLAogICAg
ICAgICAgICAicHJvdG9jb2wiOiJ2bWVzcyIsCiAgICAgICAgICAgICJzZXR0aW5ncyI6ewogICAg
ICAgICAgICAgICAgImNsaWVudHMiOlsKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAg
ICAgICAgICAgICAgICJpZCI6IlVVSUQiLAogICAgICAgICAgICAgICAgICAgICAgICAiYWx0ZXJJ
ZCI6MAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAg
fSwKICAgICAgICAgICAgInN0cmVhbVNldHRpbmdzIjp7CiAgICAgICAgICAgICAgICAibmV0d29y
ayI6IndzIiwKICAgICAgICAgICAgICAgICJ3c1NldHRpbmdzIjp7CiAgICAgICAgICAgICAgICAg
ICAgInBhdGgiOiIvV1NQQVRILXZtZXNzIgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9
LAogICAgICAgICAgICAic25pZmZpbmciOnsKICAgICAgICAgICAgICAgICJlbmFibGVkIjp0cnVl
LAogICAgICAgICAgICAgICAgImRlc3RPdmVycmlkZSI6WwogICAgICAgICAgICAgICAgICAgICJo
dHRwIiwKICAgICAgICAgICAgICAgICAgICAidGxzIgogICAgICAgICAgICAgICAgXSwKICAgICAg
ICAgICAgICAgICJtZXRhZGF0YU9ubHkiOmZhbHNlCiAgICAgICAgICAgIH0KICAgICAgICB9LAog
ICAgICAgIHsKICAgICAgICAgICAgInBvcnQiOjMwMDQsCiAgICAgICAgICAgICJsaXN0ZW4iOiIx
MjcuMC4wLjEiLAogICAgICAgICAgICAicHJvdG9jb2wiOiJ0cm9qYW4iLAogICAgICAgICAgICAi
c2V0dGluZ3MiOnsKICAgICAgICAgICAgICAgICJjbGllbnRzIjpbCiAgICAgICAgICAgICAgICAg
ICAgewogICAgICAgICAgICAgICAgICAgICAgICAicGFzc3dvcmQiOiJVVUlEIgogICAgICAgICAg
ICAgICAgICAgIH0KICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSwKICAgICAgICAgICAg
InN0cmVhbVNldHRpbmdzIjp7CiAgICAgICAgICAgICAgICAibmV0d29yayI6IndzIiwKICAgICAg
ICAgICAgICAgICJzZWN1cml0eSI6Im5vbmUiLAogICAgICAgICAgICAgICAgIndzU2V0dGluZ3Mi
OnsKICAgICAgICAgICAgICAgICAgICAicGF0aCI6Ii9XU1BBVEgtdHJvamFuIgogICAgICAgICAg
ICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAic25pZmZpbmciOnsKICAgICAgICAg
ICAgICAgICJlbmFibGVkIjp0cnVlLAogICAgICAgICAgICAgICAgImRlc3RPdmVycmlkZSI6Wwog
ICAgICAgICAgICAgICAgICAgICJodHRwIiwKICAgICAgICAgICAgICAgICAgICAidGxzIgogICAg
ICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICJtZXRhZGF0YU9ubHkiOmZhbHNlCiAgICAg
ICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgInBvcnQiOjMwMDUsCiAg
ICAgICAgICAgICJsaXN0ZW4iOiIxMjcuMC4wLjEiLAogICAgICAgICAgICAicHJvdG9jb2wiOiJz
aGFkb3dzb2NrcyIsCiAgICAgICAgICAgICJzZXR0aW5ncyI6ewogICAgICAgICAgICAgICAgImNs
aWVudHMiOlsKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICJt
ZXRob2QiOiJjaGFjaGEyMC1pZXRmLXBvbHkxMzA1IiwKICAgICAgICAgICAgICAgICAgICAgICAg
InBhc3N3b3JkIjoiVVVJRCIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBd
LAogICAgICAgICAgICAgICAgImRlY3J5cHRpb24iOiJub25lIgogICAgICAgICAgICB9LAogICAg
ICAgICAgICAic3RyZWFtU2V0dGluZ3MiOnsKICAgICAgICAgICAgICAgICJuZXR3b3JrIjoid3Mi
LAogICAgICAgICAgICAgICAgIndzU2V0dGluZ3MiOnsKICAgICAgICAgICAgICAgICAgICAicGF0
aCI6Ii9XU1BBVEgtc2hhZG93c29ja3MiCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0s
CiAgICAgICAgICAgICJzbmlmZmluZyI6ewogICAgICAgICAgICAgICAgImVuYWJsZWQiOnRydWUs
CiAgICAgICAgICAgICAgICAiZGVzdE92ZXJyaWRlIjpbCiAgICAgICAgICAgICAgICAgICAgImh0
dHAiLAogICAgICAgICAgICAgICAgICAgICJ0bHMiCiAgICAgICAgICAgICAgICBdLAogICAgICAg
ICAgICAgICAgIm1ldGFkYXRhT25seSI6ZmFsc2UKICAgICAgICAgICAgfQogICAgICAgIH0KICAg
IF0sCiAgICAiZG5zIjp7CiAgICAgICAgInNlcnZlcnMiOlsKICAgICAgICAgICAgImh0dHBzK2xv
Y2FsOi8vOC44LjguOC9kbnMtcXVlcnkiCiAgICAgICAgXQogICAgfSwKICAgICJvdXRib3VuZHMi
OlsKICAgICAgICB7CiAgICAgICAgICAgICJwcm90b2NvbCI6ImZyZWVkb20iCiAgICAgICAgfSwK
ICAgICAgICB7CiAgICAgICAgICAgICJ0YWciOiJXQVJQIiwKICAgICAgICAgICAgInByb3RvY29s
Ijoid2lyZWd1YXJkIiwKICAgICAgICAgICAgInNldHRpbmdzIjp7CiAgICAgICAgICAgICAgICAi
c2VjcmV0S2V5IjoiWUZZT0FkYncxYktUSGxOTmkrYUVqQk0zQk83dW51RkM1ck9rTVJBejlYWT0i
LAogICAgICAgICAgICAgICAgImFkZHJlc3MiOlsKICAgICAgICAgICAgICAgICAgICAiMTcyLjE2
LjAuMi8zMiIsCiAgICAgICAgICAgICAgICAgICAgIjI2MDY6NDcwMDoxMTA6OGEzNjpkZjkyOjEw
MmE6OTYwMjpmYTE4LzEyOCIKICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAicGVl
cnMiOlsKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICJwdWJs
aWNLZXkiOiJibVhPQytGMUZ4RU1GOWR5aUsySDUvMVNVdHpIMEp1Vm81MWgyd1BmZ3lvPSIsCiAg
ICAgICAgICAgICAgICAgICAgICAgICJhbGxvd2VkSVBzIjpbCiAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAiMC4wLjAuMC8wIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICI6Oi8wIgog
ICAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICAgICAiZW5kcG9p
bnQiOiIxNjIuMTU5LjE5My4xMDoyNDA4IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAg
ICAgICAgIF0sCiAgICAgICAgICAgICAgICAicmVzZXJ2ZWQiOls3OCwgMTM1LCA3Nl0sCiAgICAg
ICAgICAgICAgICAibXR1IjoxMjgwCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICBdLAogICAg
InJvdXRpbmciOnsKICAgICAgICAiZG9tYWluU3RyYXRlZ3kiOiJBc0lzIiwKICAgICAgICAicnVs
ZXMiOlsKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgInR5cGUiOiJmaWVsZCIsCiAgICAg
ICAgICAgICAgICAiZG9tYWluIjpbCiAgICAgICAgICAgICAgICAgICAgImRvbWFpbjpvcGVuYWku
Y29tIiwKICAgICAgICAgICAgICAgICAgICAiZG9tYWluOmFpLmNvbSIKICAgICAgICAgICAgICAg
IF0sCiAgICAgICAgICAgICAgICAib3V0Ym91bmRUYWciOiJXQVJQIgogICAgICAgICAgICB9CiAg
ICAgICAgXQogICAgfQp9Cg==
EOF

# 定义 UUID 及 伪装路径,请自行修改.(注意:伪装路径以 / 符号开始,为避免不必要的麻烦,请不要使用特殊符号.)
base64 -d /tmp/config > /tmp/config.json
UUID=${UUID:-'de04add9-5c68-8bab-950c-08cd5320df18'}
WSPATH=${WSPATH:-'choreo'}
sed -i "s#UUID#$UUID#g;s#WSPATH#${WSPATH}#g" /tmp/config.json

# 伪装 v2ray 执行文件
RELEASE_RANDOMNESS=$(tr -dc 'A-Za-z0-9' </dev/urandom | head -c 6)
cp v /tmp/${RELEASE_RANDOMNESS}
base64 /tmp/config.json > /tmp/config

# 如果有设置哪吒探针三个变量,会安装。如果不填或者不全,则不会安装
if [ -n "${NEZHA_SERVER}" ] && [ -n "${NEZHA_PORT}" ] && [ -n "${NEZHA_KEY}" ]; then
  TLS=${NEZHA_TLS:+'--tls'}
  wget -O /tmp/nezha-agent.zip https://github.com/nezhahq/agent/releases/latest/download/nezha-agent_linux_$(uname -m | sed "s#x86_64#amd64#; s#aarch64#arm64#").zip
  unzip /tmp/nezha-agent.zip -d /tmp
  chmod +x /tmp/nezha-agent
  rm -f /tmp/nezha-agent.zip
  nohup /tmp/nezha-agent -s ${NEZHA_SERVER}:${NEZHA_PORT} -p ${NEZHA_KEY} ${TLS} 2>&1 &
fi

# 运行 nginx 和 v2ray
nginx
base64 -d /tmp/config > /tmp/config.json
/tmp/${RELEASE_RANDOMNESS} run -c /tmp/config.json
